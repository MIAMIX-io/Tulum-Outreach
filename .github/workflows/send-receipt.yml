name: Send receipt

on:

repository_dispatch:

types: [send-receipt]

jobs:

send:

runs-on: ubuntu-latest

steps:

- name: Extract payload
    
    id: p
    
    run: |
    
    TO_EMAIL=$(jq -r '.client_[payload.to](http://payload.to) // empty' $GITHUB_EVENT_PATH)
    
    SUBJECT=$(jq -r '.client_payload.subject // empty' $GITHUB_EVENT_PATH)
    
    HTML=$(jq -r '.client_payload.html // empty' $GITHUB_EVENT_PATH)
    
    [ -z "$TO_EMAIL" ] && { echo "Missing client_[payload.to](http://payload.to)"; exit 1; }
    
    [ -z "$SUBJECT" ] && { echo "Missing client_payload.subject"; exit 1; }
    
    [ -z "$HTML" ] && { echo "Missing client_payload.html"; exit 1; }
    
    echo "to=$TO_EMAIL" >> $GITHUB_OUTPUT
    
    echo "subject=$SUBJECT" >> $GITHUB_OUTPUT
    
    echo "html<<EOF" >> $GITHUB_OUTPUT
    
    echo "$HTML" >> $GITHUB_OUTPUT
    
    echo "EOF" >> $GITHUB_OUTPUT
    
- name: Send email via SMTP (Gmail)
    
    uses: dawidd6/action-send-mail@v3
    
    with:
    
    server_address: $ secrets.SMTP_HOST       # e.g. [smtp.gmail.com](http://smtp.gmail.com)
    
    server_port: $ secrets.SMTP_PORT          # e.g. 587
    
    secure: false                                 # STARTTLS on port 587
    
    username: $ secrets.SMTP_USERNAME         # your Gmail address
    
    password: $ secrets.SMTP_APP_PASSWORD     # 16-char App Password
    
    from: $ secrets.SMTP_FROM                 # "MIAMIX Finance <finance@...>"
    
    to: $ [steps.p.outputs.to](http://steps.p.outputs.to)
    
    subject: $ steps.p.outputs.subject
    
    html_body: $ steps.p.outputs.html
    

Trigger example (repository_dispatch)

- Replace OWNER, REPO, and YOUR_GITHUB_PAT. PAT needs repo scope for private repos.

curl -X POST \

-H "Accept: application/vnd.github+json" \

-H "Authorization: token YOUR_GITHUB_PAT" \

https://api.github.com/repos/OWNER/REPO/dispatches \

-d '{

"event_type": "send-receipt",

"client_payload": {

"to": "[client@example.com](mailto:client@example.com)",

"subject": "[MIAMIX] - Payment Received: Receipt for Invoice #INV-1234",

"html": "<p>Hi Client,</p><p>Thanks for your payment.</p><p><a href="https://drive.google.com/..." target="_blank" rel="noopener">View PDF receipt</a></p>"

}

}'
